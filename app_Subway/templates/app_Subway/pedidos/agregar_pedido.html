{% extends 'app_Subway/base.html' %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h2 class="mb-4" style="color: #009246;">
            <i class="fas fa-shopping-cart me-2"></i>Crear Nuevo Pedido
        </h2>
    </div>
</div>

<div class="row">
    <div class="col-md-8">
        <div class="card card-custom">
            <div class="card-body">
                <form method="POST" id="pedidoForm">
                    {% csrf_token %}
                    
                    <!-- Información básica del pedido -->
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <label class="form-label">Cliente</label>
                            <select class="form-select" name="cliente" required>
                                <option value="">Seleccionar cliente</option>
                                {% for cliente in clientes %}
                                <option value="{{ cliente.id }}">{{ cliente.nombre }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Sucursal</label>
                            <select class="form-select" name="sucursal" required>
                                <option value="">Seleccionar sucursal</option>
                                {% for sucursal in sucursales %}
                                <option value="{{ sucursal.id }}">{{ sucursal.nombre }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <label class="form-label">Estado del Pedido</label>
                            <select class="form-select" name="estado" required>
                                <option value="pendiente">Pendiente</option>
                                <option value="preparando">Preparando</option>
                                <option value="listo">Listo</option>
                                <option value="entregado">Entregado</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Método de Pago</label>
                            <select class="form-select" name="metodo_pago" required>
                                <option value="efectivo">Efectivo</option>
                                <option value="tarjeta">Tarjeta</option>
                                <option value="transferencia">Transferencia</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- PRODUCTOS AGREGADOS -->
                    <div class="mb-4">
                        <label class="form-label fw-bold">Productos en el Pedido</label>
                        <div id="productosAgregados" class="border rounded p-3 bg-light">
                            <p class="text-muted mb-0" id="mensajeVacio">No hay productos agregados aún</p>
                        </div>
                    </div>
                    
                    <!-- Selección de nuevos productos -->
                    <div class="mb-4">
                        <label class="form-label">Agregar Más Productos</label>
                        <div class="row">
                            <div class="col-md-6">
                                <select class="form-select" id="selectProducto">
                                    <option value="">Seleccionar producto</option>
                                    {% for producto in productos %}
                                    <option value="{{ producto.id_producto }}" data-precio="{{ producto.precio }}" data-nombre="{{ producto.nombre }}">
                                        {{ producto.nombre }} - ${{ producto.precio }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-3">
                                <input type="number" class="form-control" id="inputCantidad" min="1" value="1">
                            </div>
                            <div class="col-md-3">
                                <button type="button" class="btn btn-subway w-100" onclick="agregarProducto()">
                                    <i class="fas fa-plus me-1"></i>Agregar
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Resumen del pedido -->
                    <div class="card card-custom mb-4">
                        <div class="card-header">
                            <h6 class="mb-0">Resumen del Pedido</h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-6">
                                    <strong>Total de Productos:</strong>
                                    <span id="totalProductos">0</span>
                                </div>
                                <div class="col-6">
                                    <strong>Total a Pagar:</strong>
                                    <span id="totalPagar" class="text-success fw-bold">$0.00</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Notas Adicionales</label>
                        <textarea class="form-control" name="notas" rows="2" placeholder="Instrucciones especiales..."></textarea>
                    </div>
                    
                    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                        <a href="{% url 'ver_pedidos' %}" class="btn btn-secondary me-md-2">
                            <i class="fas fa-arrow-left me-1"></i>Cancelar
                        </a>
                        <button type="submit" class="btn btn-subway">
                            <i class="fas fa-save me-1"></i>Crear Pedido
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Panel de productos disponibles -->
    <div class="col-md-4">
        <div class="card card-custom">
            <div class="card-header" style="background: linear-gradient(135deg, #009246, #CE2B37); color: white;">
                <h5 class="mb-0">
                    <i class="fas fa-hamburger me-2"></i>Productos Disponibles
                </h5>
            </div>
            <div class="card-body">
                {% for producto in productos %}
                <div class="producto-item mb-2 p-2 border rounded">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <strong>{{ producto.nombre }}</strong>
                            <br>
                            <small class="text-muted">{{ producto.get_tipo_display }}</small>
                        </div>
                        <div class="text-end">
                            <strong class="text-success">${{ producto.precio }}</strong>
                            <br>
                            <small class="text-muted">{{ producto.calorias }} cal</small>
                        </div>
                    </div>
                </div>
                {% empty %}
                <p class="text-muted">No hay productos disponibles</p>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<script>
let productosEnPedido = [];

function agregarProducto() {
    const select = document.getElementById('selectProducto');
    const cantidadInput = document.getElementById('inputCantidad');
    
    if (!select.value) {
        alert('Por favor selecciona un producto');
        return;
    }
    
    const productoId = select.value;
    const productoNombre = select.options[select.selectedIndex].getAttribute('data-nombre');
    const productoPrecio = parseFloat(select.options[select.selectedIndex].getAttribute('data-precio'));
    const cantidad = parseInt(cantidadInput.value);
    
    if (isNaN(cantidad) || cantidad < 1) {
        alert('La cantidad debe ser un número válido mayor a 0');
        return;
    }
    
    // Verificar si el producto ya existe
    const productoExistenteIndex = productosEnPedido.findIndex(p => p.id === productoId);
    
    if (productoExistenteIndex !== -1) {
        // Si ya existe, actualizar cantidad
        productosEnPedido[productoExistenteIndex].cantidad += cantidad;
        productosEnPedido[productoExistenteIndex].subtotal = productosEnPedido[productoExistenteIndex].cantidad * productosEnPedido[productoExistenteIndex].precio;
    } else {
        // Si no existe, agregar nuevo
        productosEnPedido.push({
            id: productoId,
            nombre: productoNombre,
            precio: productoPrecio,
            cantidad: cantidad,
            subtotal: productoPrecio * cantidad
        });
    }
    
    // Actualizar la vista
    actualizarVistaProductos();
    
    // Limpiar selección
    select.value = '';
    cantidadInput.value = 1;
}

function eliminarProducto(index) {
    productosEnPedido.splice(index, 1);
    actualizarVistaProductos();
}

function actualizarVistaProductos() {
    const container = document.getElementById('productosAgregados');
    const mensajeVacio = document.getElementById('mensajeVacio');
    
    if (productosEnPedido.length === 0) {
        container.innerHTML = '<p class="text-muted mb-0" id="mensajeVacio">No hay productos agregados aún</p>';
    } else {
        let html = '<div class="table-responsive"><table class="table table-sm table-bordered">';
        html += '<thead><tr><th>Producto</th><th>Cantidad</th><th>Precio</th><th>Subtotal</th><th>Acción</th></tr></thead><tbody>';
        
        productosEnPedido.forEach((producto, index) => {
            html += `
                <tr>
                    <td>${producto.nombre}</td>
                    <td>${producto.cantidad}</td>
                    <td>$${producto.precio.toFixed(2)}</td>
                    <td>$${producto.subtotal.toFixed(2)}</td>
                    <td class="text-center">
                        <button type="button" class="btn btn-danger btn-sm" onclick="eliminarProducto(${index})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `;
        });
        
        html += '</tbody></table></div>';
        container.innerHTML = html;
    }
    
    // Actualizar totales
    const totalProductos = productosEnPedido.reduce((sum, p) => sum + p.cantidad, 0);
    const totalPagar = productosEnPedido.reduce((sum, p) => sum + p.subtotal, 0);
    
    document.getElementById('totalProductos').textContent = totalProductos;
    document.getElementById('totalPagar').textContent = `$${totalPagar.toFixed(2)}`;
    
    // Agregar campo hidden para el total
    let totalHidden = document.getElementById('totalHidden');
    if (!totalHidden) {
        totalHidden = document.createElement('input');
        totalHidden.type = 'hidden';
        totalHidden.name = 'total';
        totalHidden.id = 'totalHidden';
        document.getElementById('pedidoForm').appendChild(totalHidden);
    }
    totalHidden.value = totalPagar.toFixed(2);
}

// Manejar envío del formulario
document.getElementById('pedidoForm').addEventListener('submit', function(e) {
    if (productosEnPedido.length === 0) {
        e.preventDefault();
        alert('Debes agregar al menos un producto al pedido');
        return;
    }
    
    // Limpiar campos hidden anteriores
    document.querySelectorAll('input[name^="producto_"]').forEach(input => input.remove());
    
    // Agregar productos como campos ocultos al formulario
    productosEnPedido.forEach((producto, index) => {
        const inputId = document.createElement('input');
        inputId.type = 'hidden';
        inputId.name = `producto_${index}_id`;
        inputId.value = producto.id;
        this.appendChild(inputId);
        
        const inputCantidad = document.createElement('input');
        inputCantidad.type = 'hidden';
        inputCantidad.name = `producto_${index}_cantidad`;
        inputCantidad.value = producto.cantidad;
        this.appendChild(inputCantidad);
    });
    
    console.log('Enviando pedido con productos:', productosEnPedido);
});

// Inicializar
document.addEventListener('DOMContentLoaded', function() {
    actualizarVistaProductos();
});
</script>

<style>
.producto-item {
    transition: all 0.3s ease;
    cursor: pointer;
}
.producto-item:hover {
    background-color: #e9ecef;
    transform: translateY(-2px);
}
.table th {
    background-color: #009246;
    color: white;
    border: none;
}
</style>
{% endblock %}